<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PetPair - Profile</title>
  <style>
  
  html, body {
    height: 100%;
    margin: 0;
  }
  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    font-family: 'Segoe UI', sans-serif;
    background-color: #F5F5DC;
    color: #4B2E2E;
  }
  main {
    flex-grow: 1;
    padding: 2rem 1rem;
    max-width: 600px;
    margin: 0 auto;
  }

  /* Navbar */
  nav.navbar {
    background-color: #4B2E2E;
    color: #F5F5DC;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1.5rem;
    flex-wrap: wrap;
  }
  .navbar-brand {
    font-size: 1.8rem;
    font-weight: bold;
    color: #FFEFD5;
  }
  .navbar-links {
    list-style: none;
    display: flex;
    gap: 1.2rem;
    margin: 0;
    padding: 0;
  }
  .navbar-links li a {
    color: #F5F5DC;
    text-decoration: none;
    font-weight: 500;
  }
  .navbar-links li a:hover {
    color: #EFE5DA;
  }
  .hamburger {
    font-size: 1.8rem;
    display: none;
    cursor: pointer;
    color: #FFEFD5;
  }
  #toggle {
    display: none;
  }
  @media (max-width: 768px) {
    .navbar-links {
      flex-direction: column;
      width: 100%;
      display: none;
      background-color: #4B2E2E;
      padding: 1rem 0;
      position: absolute;
      top: 100%;
      left: 0;
    }
    #toggle:checked + .hamburger + .navbar-links {
      display: flex;
    }
    .hamburger {
      display: block;
    }
  }

  /* Profile Container */
  .profile-container {
    background-color: #F5F5DC;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(75, 46, 46, 0.2);
    padding: 1rem;
  }

  .profile-container h2,
  .contact-section h3 {
    color: #6B4C4C;
    text-align: center;
    margin-bottom: 1rem;
  }
  .profile-container p {
    text-align: center;
    margin-bottom: 2rem;
    font-weight: 500;
  }


  .contact-form label {
    display: block;
    margin-bottom: 1rem;
    font-weight: 600;
  }
  .contact-form input,
  .contact-form textarea {
    width: 100%;
    padding: 0.6rem;
    border: 1.5px solid #4B2E2E;
    border-radius: 5px;
    font-size: 1rem;
    margin-top: 0.3rem;
    font-family: 'Segoe UI', sans-serif;
  }
  .contact-form button {
    display: block;
    width: 100%;
    padding: 0.8rem;
    background-color: #4B2E2E;
    color: #F5F5DC;
    font-size: 1.2rem;
    font-weight: 700;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 1.5rem;
    transition: background-color 0.3s ease;
  }
  .contact-form button:hover {
    background-color: #6B4C4C;
  }

  #logoutBtn {
  display: block;
  width: 100%;
  padding: 0.8rem;
  background-color: #4B2E2E;
  color: #F5F5DC;
  font-size: 1.1rem;
  font-weight: 700;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  margin-top: 1rem;
  transition: background-color 0.3s ease;
}
#logoutBtn:hover {
  background-color: #6B4C4C;
}

  /* Footer */
  footer.footer-container {
    background-color: #4B2E2E;
    color: #F5F5DC;
    text-align: center;
    padding: 1rem 0;
    margin-top: auto;
    font-family: 'Segoe UI', sans-serif;
  }
  .footer-links {
    margin-bottom: 0.7rem;
  }
  .footer-links a {
    color: #F5F5DC;
    margin: 0 1rem;
    text-decoration: none;
    font-weight: 600;
    transition: color 0.3s ease;
  }
  .footer-links a:hover {
    color: #EFE5DA;
  }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-brand">PetPair</div>
    <input type="checkbox" id="toggle" />
    <label for="toggle" class="hamburger">&#9776;</label>
    <ul class="navbar-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="petform.html">Find a Pet</a></li>
      <li><a href="pets.html">Pets</a></li>
      <li><a href="admin.html">Admin</a></li>
      <li><a href="profile.html">Profile</a></li>
      <li id="auth-link"><a href="login.html">Login</a></li>
    </ul>
  </nav>

  <!-- Main -->
  <main>
    <div class="profile-container">
      <h2>Your Profile</h2>
      <p id="welcomeText">Welcome back! Manage your preferences or contact us below.</p>
      <p>Welcome, <span id="userEmail"></span></p>
    <button id="logoutBtn">Logout</button>

      <!-- Contact Form -->
      <section class="contact-section">
        <h3>Contact Us</h3>
        <form id="contactForm" class="contact-form">
          <label>
            Name:
            <input type="text" name="name" id="name" required />
          </label>
          <label>
            Email:
            <input type="email" name="email" id="email" required />
          </label>
          <label>
            Message:
            <textarea name="message" id="message" rows="4" required></textarea>
          </label>
          <button type="submit">Send Message</button>
        </form>
      </section>
    </div>
<section style="
  max-width: 600px; 
  margin: 2rem auto; 
  background-color: #F5F5DC;
  padding: 1.5rem 2rem; 
  border-radius: 10px; 
  box-shadow: 0 4px 12px rgba(75, 46, 46, 0.15); 
  color: #4B2E2E;
  font-family: 'Segoe UI', sans-serif;
">
  <h3 style="text-align: center; margin-bottom: 1.2rem;">Your Adoption Requests</h3>
  <div id="requestsContainer"></div>
</section>

<section id="adminSection" style="display:none; 
  max-width: 600px; 
  margin: 2rem auto; 
  background-color: #F5F5DC;
  padding: 1.5rem 2rem; 
  border-radius: 10px; 
  box-shadow: 0 4px 12px rgba(75, 46, 46, 0.15); 
  color: #4B2E2E;
  font-family: 'Segoe UI', sans-serif;">
  <h3 style="text-align: center; margin-bottom: 1.2rem;">All Adoption Requests (Admin)</h3>
  <div id="adminRequestsContainer"></div>
</section>


<section style="
  max-width: 600px; 
  margin: 2rem auto; 
  background-color: #F5F5DC;
  padding: 1.5rem 2rem; 
  border-radius: 10px; 
  box-shadow: 0 4px 12px rgba(75, 46, 46, 0.15); 
  color: #4B2E2E;
  font-family: 'Segoe UI', sans-serif;
">
  <h3 style="text-align: center; margin-bottom: 1.2rem;">Approved Adoptions</h3>
  <div id="adoptionsContainer"></div>
</section>





  </main>


  <footer class="footer-container">
    <div class="footer-links">
      <a href="index.html">Home</a>
      <a href="petform.html">Find a Pet</a>
      <a href="admin.html">Admin</a>
      <a href="profile.html">Profile</a>
      <a href="contact.html">Contact Us</a>
    </div>
    <p>Â© 2025 PetPair. All rights reserved.</p>
  </footer>


<script>
// const authLinkLi = document.getElementById('auth-link');
// const welcomeText = document.getElementById('welcomeText');
// const user = JSON.parse(localStorage.getItem('user'));
// document.getElementById('userEmail').textContent = `Mail: ${user.email}`;

// function updateAuthLink() {
//   if (user) {
//     authLinkLi.innerHTML = '<a href="#" id="logoutLink">Logout</a>';
//     document.getElementById('logoutLink').addEventListener('click', () => {
//       localStorage.removeItem('user');
//       alert('Logged out successfully.');
//       window.location.href = 'index.html';
//     });

//     if (user.name || user.email) {
//       welcomeText.textContent = `Welcome, ${user.name || user.email}! You can manage your preferences or contact us below.`;
//       document.getElementById('name').value = user.name || '';
//       document.getElementById('email').value = user.email || '';
//     }
//   } else {
//     authLinkLi.innerHTML = '<a href="login.html">Login</a>';
//   }
// }

// updateAuthLink();

// document.addEventListener('DOMContentLoaded', async () => {
//   const authLinkLi = document.getElementById('auth-link');
//   const welcomeText = document.getElementById('welcomeText');
//   const userEmailSpan = document.getElementById('userEmail');
//   const logoutBtn = document.getElementById('logoutBtn');

//   const user = JSON.parse(localStorage.getItem('user'));

//   if (!user || !user.token) {
//     alert('You are not logged in.');
//     window.location.href = 'login.html';
//     return;
//   }

//   authLinkLi.innerHTML = '<a href="#" id="logoutLink">Logout</a>';

//   document.getElementById('logoutLink').addEventListener('click', () => {
//     localStorage.removeItem('user');
//     alert('Logged out successfully.');
//     window.location.href = 'index.html';
//   });

//   welcomeText.textContent = `Welcome, ${user.email}! You can manage your preferences or contact us below.`;
//   userEmailSpan.textContent = `Mail: ${user.email}`;

//   try {
//     const res = await fetch('http://localhost:5000/api/me', {
//       headers: { 'Authorization': `Bearer ${user.token}` }
//     });

//     if (!res.ok) {
//       throw new Error('Failed to fetch profile');
//     }

//     const data = await res.json();
//     userEmailSpan.textContent = `Mail: ${data.email}`;
//   } catch (err) {
//     alert('Session expired. Please login again.');
//     localStorage.removeItem('user');
//     window.location.href = 'login.html';
//   }

//   logoutBtn.addEventListener('click', () => {
//     localStorage.removeItem('user');
//     window.location.href = 'login.html';
//   });

//   if (user.role === 'admin') {
//     document.getElementById('requestsContainer').parentElement.style.display = 'none'; // hide user requests section for admin
//     document.getElementById('adoptionsContainer').parentElement.style.display = 'none'; // hide user adoptions section for admin
//     document.getElementById('adminSection').style.display = 'block'; // show admin section

//     loadAdminRequests();
//   } else {
//     // Normal user view
//     document.getElementById('adminSection').style.display = 'none';
//     loadAdoptionRequests();
//     loadApprovedAdoptions();
//   }
// });

// async function loadAdoptionRequests() {
//   const user = JSON.parse(localStorage.getItem('user'));
//   if (!user?.token) {
//     alert('Please login first');
//     window.location.href = 'login.html';
//     return;
//   }

//   try {
//     const res = await fetch('http://localhost:5000/api/requests', {
//       headers: { Authorization: `Bearer ${user.token}` }
//     });
//     if (!res.ok) throw new Error('Failed to load requests');

//     const requests = await res.json();

//     const container = document.getElementById('requestsContainer');
//     container.innerHTML = '';

//     if (requests.length === 0) {
//       container.innerHTML = '<p style="text-align:center;">No adoption requests found.</p>';
//       return;
//     }

//     requests.forEach(req => {
//         const statusText = req.status || 'Pending';
//       let statusDisplay = statusText;

//       // Optional: Customize status display for rejected requests
//       if (statusText.toLowerCase() === 'rejected') {
//         statusDisplay = '<span style="color:#b23a3a; font-weight:bold;">Request Rejected</span>';
//       } else if (statusText.toLowerCase() === 'approved') {
//         statusDisplay = '<span style="color:green; font-weight:bold;">Approved</span>';
//       } else {
//         statusDisplay = `<span>${statusText}</span>`;
//       }

//       const div = document.createElement('div');
//       div.style = 'border-bottom:1px solid #c2b2a3; padding:0.5rem 0;';
//       div.innerHTML = `
//         <p style="text-align:center;"><strong>Pet:</strong> ${req.petName}</p>
//         <p style="text-align:center;"><strong>Reason:</strong> ${req.reason}</p>
//         <p style="text-align:center;"><strong>Contact:</strong> ${req.contact}</p>
        
//         <p style="text-align:center;"><strong>Status:</strong> ${statusDisplay}</p>
//          ${req.deliveryTracking ? `<p style="text-align:center;"><strong>Tracking:</strong> ${req.deliveryTracking}</p>` : ''}
//         <button data-id="${req._id}" class="cancel-btn" style="background:#4B2E2E; color:#F5F5DC; border:none; border-radius:5px; padding:6px 12px; cursor:pointer;display:block; margin:0.5rem auto;">Cancel Request</button>
//       `;
//       container.appendChild(div);
//     });

//     document.querySelectorAll('.cancel-btn').forEach(btn => {
//       btn.addEventListener('click', async (e) => {
//         const id = e.target.dataset.id;
//         if (!confirm('Cancel this adoption request?')) return;

//         const res = await fetch(`http://localhost:5000/api/requests/${id}`, {
//           method: 'DELETE',
//           headers: { Authorization: `Bearer ${user.token}` }
//         });

//         if (res.ok) {
//           alert('Request cancelled');
//           loadAdoptionRequests(); // refresh list
//         } else {
//           const err = await res.json();
//           alert('Error: ' + (err.message || 'Failed to cancel'));
//         }
//       });
//     });
//   } catch (error) {
//     alert('Error loading requests: ' + error.message);
//   }
// }

// async function loadApprovedAdoptions() {
//   const user = JSON.parse(localStorage.getItem('user'));
//   if (!user?.token) return;

//   try {
//     const res = await fetch('http://localhost:5000/api/adoptions', {
//       headers: { Authorization: `Bearer ${user.token}` }
//     });

//     if (!res.ok) throw new Error('Failed to load adoptions');

//     const adoptions = await res.json();
//     const container = document.getElementById('adoptionsContainer');
//     container.innerHTML = '';



//     adoptions.forEach(adopt => {
//       const div = document.createElement('div');
//       div.style = 'border-bottom:1px solid #c2b2a3; padding:0.5rem 0;';
//       div.innerHTML = `
//         <p style="text-align:center;"><strong>Pet:</strong> ${adopt.pet.name}</p>
//         <p style="text-align:center;"><strong>Status:</strong> Adopted</p>
//         ${adopt.estimatedArrival ? `<p style="text-align:center;"><strong>Estimated Arrival:</strong> ${adopt.estimatedArrival}</p>` : ''}
//         ${adopt.deliveryTracking ? `<p style="text-align:center;"><strong>Tracking:</strong> ${adopt.deliveryTracking}</p>` : ''}
//       `;
//       container.appendChild(div);
//     });
//   } catch (error) {
//     console.error('Error loading adoptions:', error);
//   }
// }

// async function loadAdminRequests() {
//   const user = JSON.parse(localStorage.getItem('user'));
//   if (!user || user.role !== 'admin') return;

//   try {
//     const res = await fetch('http://localhost:5000/api/admin/requests', {
//       headers: { Authorization: `Bearer ${user.token}` }
//     });

//     if (!res.ok) throw new Error('Failed to load admin requests');

//     const requests = await res.json();

//     // Show only requests with status Pending for admin review
//     const pendingRequests = requests.filter(req => req.status === 'Pending');

//     const container = document.getElementById('adminRequestsContainer');
//     container.innerHTML = '';

//     if (pendingRequests.length === 0) {
//       container.innerHTML = '<p style="text-align:center;">No pending adoption requests found.</p>';
//       return;
//     }

//     pendingRequests.forEach(req => {
//       const div = document.createElement('div');
//       div.style = 'border-bottom:1px solid #c2b2a3; padding:0.5rem 0; background:#f9eaea; margin-bottom: 1rem; border-radius: 6px;';
//       div.innerHTML = `
//         <p><strong>User Email:</strong> ${req.userEmail}</p>
//         <p><strong>Pet:</strong> ${req.petName}</p>
//         <p><strong>Reason:</strong> ${req.reason}</p>
//         <p><strong>Contact:</strong> ${req.contact}</p>
//         <p><strong>Status:</strong> <span class="status">${req.status}</span></p>
//         <label>Estimated Arrival: <input type="text" class="estimatedArrival" value="" /></label><br/>
//         <label>Delivery Tracking: <input type="text" class="deliveryTracking" value="" /></label><br/>
//         <button class="approveBtn" data-id="${req._id}" style="background:#4B2E2E; color:#F5F5DC; border:none; border-radius:5px; padding:6px 12px; cursor:pointer; margin-top:0.5rem; margin-right: 10px;">
//           Approve
//         </button>
//         <button class="rejectBtn" data-id="${req._id}" style="background:#b23a3a; color:#F5F5DC; border:none; border-radius:5px; padding:6px 12px; cursor:pointer; margin-top:0.5rem;">
//           Don't Approve
//         </button>
//       `;
//       container.appendChild(div);
//     });

//     container.onclick = async (e) => {
//       if (e.target.classList.contains('approveBtn')) {
//         const parent = e.target.closest('div');
//         const requestId = e.target.dataset.id;
//         const estimatedArrival = parent.querySelector('.estimatedArrival').value.trim();
//         const deliveryTracking = parent.querySelector('.deliveryTracking').value.trim();

//         if (!estimatedArrival || !deliveryTracking) {
//           alert('Please fill in both Estimated Arrival and Delivery Tracking.');
//           return;
//         }

//         try {
//           const res = await fetch(`http://localhost:5000/api/requests/${requestId}`, {
//             method: 'PATCH',
//             headers: {
//               'Authorization': `Bearer ${user.token}`,
//               'Content-Type': 'application/json'
//             },
//             body: JSON.stringify({
//               status: 'Approved',
//               estimatedArrival,
//               deliveryTracking
//             })
//           });

//           if (!res.ok) {
//             const err = await res.json();
//             alert('Error: ' + (err.message || 'Failed to approve request.'));
//             return;
//           }

//           alert('Request approved!');
//           loadAdminRequests();
//         } catch (error) {
//           alert('Network error: ' + error.message);
//         }
//       } else if (e.target.classList.contains('rejectBtn')) {
//         const parent = e.target.closest('div');
//         const requestId = e.target.dataset.id;

//         if (!confirm('Reject this adoption request?')) return;

//         try {
//           const res = await fetch(`http://localhost:5000/api/requests/${requestId}`, {
//             method: 'PATCH',
//             headers: {
//               'Authorization': `Bearer ${user.token}`,
//               'Content-Type': 'application/json'
//             },
//             body: JSON.stringify({
//               status: 'Rejected',
//               estimatedArrival: '',
//               deliveryTracking: ''
//             })
//           });

//           if (!res.ok) {
//             const err = await res.json();
//             alert('Error: ' + (err.message || 'Failed to reject request.'));
//             return;
//           }

//           alert('Request rejected!');
//           loadAdminRequests();
//         } catch (error) {
//           alert('Network error: ' + error.message);
//         }
//       }
//     };

//   } catch (error) {
//     alert('Error loading admin requests: ' + error.message);
//   }
// }

// async function cancelAdoption(adoptionId) {
//     if (!confirm('Are you sure you want to cancel this adoption?')) return;

//     try {
//       const token = localStorage.getItem('token');
//       const response = await fetch(`/api/adoptions/${adoptionId}`, {
//         method: 'DELETE',
//         headers: {
//           'Authorization': `Bearer ${token}`
//         }
//       });

//       const data = await response.json();

//       if (response.ok) {
//         alert('Adoption cancelled successfully');
//         window.location.reload();
//       } else {
//         alert(data.message || 'Failed to cancel adoption');
//       }
//     } catch (err) {
//       console.error('Error cancelling adoption:', err);
//       alert('An error occurred');
//     }
//   }





const authLinkLi = document.getElementById('auth-link');
const welcomeText = document.getElementById('welcomeText');
const user = JSON.parse(localStorage.getItem('user'));
document.getElementById('userEmail').textContent = `Mail: ${user.email}`;

function updateAuthLink() {
  if (user) {
    authLinkLi.innerHTML = '<a href="#" id="logoutLink">Logout</a>';
    document.getElementById('logoutLink').addEventListener('click', () => {
      localStorage.removeItem('user');
      alert('Logged out successfully.');
      window.location.href = 'index.html';
    });

    if (user.name || user.email) {
      welcomeText.textContent = `Welcome, ${user.name || user.email}! You can manage your preferences or contact us below.`;
      document.getElementById('name').value = user.name || '';
      document.getElementById('email').value = user.email || '';
    }
  } else {
    authLinkLi.innerHTML = '<a href="login.html">Login</a>';
  }
}

updateAuthLink();

document.addEventListener('DOMContentLoaded', async () => {
  const authLinkLi = document.getElementById('auth-link');
  const welcomeText = document.getElementById('welcomeText');
  const userEmailSpan = document.getElementById('userEmail');
  const logoutBtn = document.getElementById('logoutBtn');

  const user = JSON.parse(localStorage.getItem('user'));

  if (!user || !user.token) {
    alert('You are not logged in.');
    window.location.href = 'login.html';
    return;
  }

  authLinkLi.innerHTML = '<a href="#" id="logoutLink">Logout</a>';

  document.getElementById('logoutLink').addEventListener('click', () => {
    localStorage.removeItem('user');
    alert('Logged out successfully.');
    window.location.href = 'index.html';
  });

  welcomeText.textContent = `Welcome, ${user.email}! You can manage your preferences or contact us below.`;
  userEmailSpan.textContent = `Mail: ${user.email}`;

  try {
    const res = await fetch('http://localhost:5000/api/me', {
      headers: { 'Authorization': `Bearer ${user.token}` }
    });

    if (!res.ok) {
      throw new Error('Failed to fetch profile');
    }

    const data = await res.json();
    userEmailSpan.textContent = `Mail: ${data.email}`;
  } catch (err) {
    alert('Session expired. Please login again.');
    localStorage.removeItem('user');
    window.location.href = 'login.html';
  }

  logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('user');
    window.location.href = 'login.html';
  });

  if (user.role === 'admin') {
    document.getElementById('requestsContainer').parentElement.style.display = 'none'; // hide user requests section for admin
    document.getElementById('adoptionsContainer').parentElement.style.display = 'none'; // hide user adoptions section for admin
    document.getElementById('adminSection').style.display = 'block'; // show admin section

    loadAdminRequests();
  } else {
    // Normal user view
    document.getElementById('adminSection').style.display = 'none';
    loadAdoptionRequests();
    loadApprovedAdoptions();
  }
});

async function loadAdoptionRequests() {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user?.token) {
    alert('Please login first');
    window.location.href = 'login.html';
    return;
  }

  try {
    const res = await fetch('http://localhost:5000/api/requests', {
      headers: { Authorization: `Bearer ${user.token}` }
    });
    if (!res.ok) throw new Error('Failed to load requests');

    const requests = await res.json();

    const container = document.getElementById('requestsContainer');
    container.innerHTML = '';

    if (requests.length === 0) {
      container.innerHTML = '<p style="text-align:center;">No adoption requests found.</p>';
      return;
    }

    requests.forEach(req => {
      const statusText = req.status || 'Pending';
      let statusDisplay = statusText;

      if (statusText.toLowerCase() === 'rejected') {
        statusDisplay = '<span style="color:#b23a3a; font-weight:bold;">Request Rejected</span>';
      } else if (statusText.toLowerCase() === 'approved') {
        statusDisplay = '<span style="color:green; font-weight:bold;">Approved</span>';
      } else {
        statusDisplay = `<span>${statusText}</span>`;
      }

      const div = document.createElement('div');
      div.style = 'border-bottom:1px solid #c2b2a3; padding:0.5rem 0;';
      div.innerHTML = `
        <p style="text-align:center;"><strong>Pet:</strong> ${req.petName}</p>
        <p style="text-align:center;"><strong>Reason:</strong> ${req.reason}</p>
        <p style="text-align:center;"><strong>Contact:</strong> ${req.contact}</p>
        <p style="text-align:center;"><strong>Status:</strong> ${statusDisplay}</p>
        ${req.deliveryTracking ? `<p style="text-align:center;"><strong>Tracking:</strong> ${req.deliveryTracking}</p>` : ''}
        <button data-id="${req._id}" class="cancel-btn" style="background:#4B2E2E; color:#F5F5DC; border:none; border-radius:5px; padding:6px 12px; cursor:pointer;display:block; margin:0.5rem auto;">Cancel Request</button>
      `;
      container.appendChild(div);
    });

    document.querySelectorAll('.cancel-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        if (!confirm('Cancel this adoption request?')) return;

        const res = await fetch(`http://localhost:5000/api/requests/${id}`, {
          method: 'DELETE',
          headers: { Authorization: `Bearer ${user.token}` }
        });

        if (res.ok) {
          alert('Request cancelled');
          loadAdoptionRequests(); // refresh list
        } else {
          const err = await res.json();
          alert('Error: ' + (err.message || 'Failed to cancel'));
        }
      });
    });
  } catch (error) {
    alert('Error loading requests: ' + error.message);
  }
}

async function loadApprovedAdoptions() {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user?.token) return;

  try {
    const res = await fetch('http://localhost:5000/api/adoptions', {
      headers: { Authorization: `Bearer ${user.token}` }
    });

    if (!res.ok) throw new Error('Failed to load adoptions');

    const adoptions = await res.json();
    const container = document.getElementById('adoptionsContainer');
    container.innerHTML = '';

    adoptions.forEach(adopt => {
      const div = document.createElement('div');
      div.style = 'border-bottom:1px solid #c2b2a3; padding:0.5rem 0;';
      div.innerHTML = `
        <p style="text-align:center;"><strong>Pet:</strong> ${adopt.pet.name}</p>
        <p style="text-align:center;"><strong>Status:</strong> Adopted</p>
        ${adopt.estimatedArrival ? `<p style="text-align:center;"><strong>Estimated Arrival:</strong> ${adopt.estimatedArrival}</p>` : ''}
        ${adopt.deliveryTracking ? `<p style="text-align:center;"><strong>Tracking:</strong> ${adopt.deliveryTracking}</p>` : ''}
        <button data-id="${adopt._id}" class="cancel-adoption-btn" style="background:#4B2E2E; color:#F5F5DC; border:none; border-radius:5px; padding:6px 12px; cursor:pointer; display:block; margin:0.5rem auto;">
          Cancel Adoption
        </button>
      `;
      container.appendChild(div);
    });

    document.querySelectorAll('.cancel-adoption-btn').forEach(button => {
      button.addEventListener('click', async (e) => {
        const adoptionId = e.target.getAttribute('data-id');
        if (!confirm('Are you sure you want to cancel this adoption?')) return;

        try {
          const res = await fetch(`http://localhost:5000/api/adoptions/${adoptionId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${user.token}`
            }
          });

          if (res.ok) {
            alert('Adoption cancelled successfully.');
            loadApprovedAdoptions(); // refresh list
          } else {
            const err = await res.json();
            alert('Failed to cancel adoption: ' + (err.message || 'Unknown error'));
          }
        } catch (err) {
          alert('Error cancelling adoption: ' + err.message);
        }
      });
    });

  } catch (error) {
    console.error('Error loading adoptions:', error);
  }
}

async function loadAdminRequests() {
  const user = JSON.parse(localStorage.getItem('user'));
  if (!user || user.role !== 'admin') return;

  try {
    const res = await fetch('http://localhost:5000/api/admin/requests', {
      headers: { Authorization: `Bearer ${user.token}` }
    });

    if (!res.ok) throw new Error('Failed to load admin requests');

    const requests = await res.json();

    const pendingRequests = requests.filter(req => req.status === 'Pending');

    const container = document.getElementById('adminRequestsContainer');
    container.innerHTML = '';

    if (pendingRequests.length === 0) {
      container.innerHTML = '<p style="text-align:center;">No pending adoption requests found.</p>';
      return;
    }

    pendingRequests.forEach(req => {
      const div = document.createElement('div');
      div.style = 'border-bottom:1px solid #c2b2a3; padding:0.5rem 0; background:#f9eaea; margin-bottom: 1rem; border-radius: 6px;';
      div.innerHTML = `
        <p><strong>User Email:</strong> ${req.userEmail}</p>
        <p><strong>Pet:</strong> ${req.petName}</p>
        <p><strong>Reason:</strong> ${req.reason}</p>
        <p><strong>Contact:</strong> ${req.contact}</p>
        <p><strong>Status:</strong> <span class="status">${req.status}</span></p>
        <label>Estimated Arrival: <input type="text" class="estimatedArrival" value="" /></label><br/>
        <label>Delivery Tracking: <input type="text" class="deliveryTracking" value="" /></label><br/>
        <button class="approveBtn" data-id="${req._id}" style="background:#4B2E2E; color:#F5F5DC; border:none; border-radius:5px; padding:6px 12px; cursor:pointer; margin-top:0.5rem; margin-right: 10px;">
          Approve
        </button>
        <button class="rejectBtn" data-id="${req._id}" style="background:#b23a3a; color:#F5F5DC; border:none; border-radius:5px; padding:6px 12px; cursor:pointer; margin-top:0.5rem;">
          Don't Approve
        </button>
      `;
      container.appendChild(div);
    });

    container.onclick = async (e) => {
      if (e.target.classList.contains('approveBtn')) {
        const parent = e.target.closest('div');
        const requestId = e.target.dataset.id;
        const estimatedArrival = parent.querySelector('.estimatedArrival').value.trim();
        const deliveryTracking = parent.querySelector('.deliveryTracking').value.trim();

        if (!estimatedArrival || !deliveryTracking) {
          alert('Please fill in both Estimated Arrival and Delivery Tracking.');
          return;
        }

        try {
          const res = await fetch(`http://localhost:5000/api/requests/${requestId}`, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${user.token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              status: 'Approved',
              estimatedArrival,
              deliveryTracking
            })
          });

          if (!res.ok) {
            const err = await res.json();
            alert('Error: ' + (err.message || 'Failed to approve request.'));
            return;
          }

          alert('Request approved!');
          loadAdminRequests();
        } catch (error) {
          alert('Network error: ' + error.message);
        }
      } else if (e.target.classList.contains('rejectBtn')) {
        const parent = e.target.closest('div');
        const requestId = e.target.dataset.id;

        if (!confirm('Reject this adoption request?')) return;

        try {
          const res = await fetch(`http://localhost:5000/api/requests/${requestId}`, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${user.token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              status: 'Rejected',
              estimatedArrival: '',
              deliveryTracking: ''
            })
          });

          if (!res.ok) {
            const err = await res.json();
            alert('Error: ' + (err.message || 'Failed to reject request.'));
            return;
          }

          alert('Request rejected!');
          loadAdminRequests();
        } catch (error) {
          alert('Network error: ' + error.message);
        }
      }
    };

  } catch (error) {
    alert('Error loading admin requests: ' + error.message);
  }
}


 </script>


</body>
</html>
